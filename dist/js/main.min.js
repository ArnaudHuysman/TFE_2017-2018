"use strict";var scene,scene2,camera,fieldOfView,aspectRatio,nearPlane,farPlane,HEIGHT,WIDTH,renderer,container,raycaster,plane,intersectPoint,hemisphereLight,shadowLight,Colors={orange:15023360,yellow:16771328,white:16580599,blue:2203808,blueDark:288869},Player={isRightClick:!1,isLeftClick:!1,targetPos:{x:0,y:0}},Game={collidableMesh:[],enemies:[]};function createScene(){HEIGHT=window.innerHeight,WIDTH=window.innerWidth,scene=new THREE.Scene,aspectRatio=WIDTH/HEIGHT,fieldOfView=60,nearPlane=1,farPlane=1e4,(camera=new THREE.PerspectiveCamera(fieldOfView,aspectRatio,nearPlane,farPlane)).position.z=400,camera.position.y=-250,camera.lookAt(new THREE.Vector3(0,-40,0)),plane=new THREE.Plane(new THREE.Vector3(1,0,0),10),intersectPoint=new THREE.Vector3,(renderer=new THREE.WebGLRenderer({alpha:!0,antialias:!0})).setPixelRatio(window.devicePixelRatio),renderer.setSize(WIDTH,HEIGHT),renderer.shadowMap.enabled=!0,raycaster=new THREE.Raycaster,(container=document.getElementById("world")).appendChild(renderer.domElement),window.addEventListener("resize",handleWindowResize,!1)}function handleWindowResize(){HEIGHT=window.innerHeight,WIDTH=window.innerWidth,renderer.setSize(WIDTH,HEIGHT),camera.aspect=WIDTH/HEIGHT,camera.updateProjectionMatrix()}function createLights(){var e=new THREE.PointLight(16777215);e.position.set(0,-600,600),scene.add(e)}window.addEventListener("load",init,!1);var direction=null;function handleKeyBoardDown(e){switch(e.keyCode){case 37:e.preventDefault(),direction="left";break;case 38:e.preventDefault(),direction="up";break;case 39:e.preventDefault(),direction="right";break;case 40:e.preventDefault(),direction="down"}}function handleKeyBoardUp(e){}var enemiesCollision,mousePos=new THREE.Vector2(0,0),mouseProjectPos=new THREE.Vector3(0,0,0),rightClick={x:0,z:0};function handleMouseMove(e){var t=e.clientX/WIDTH*2-1,o=1-e.clientY/HEIGHT*2;mouseProjectPos=toWorldPosition(e,mousePos={x:t,y:o})}function toScreenPosition(e,t){var o=new THREE.Vector3,i=.5*renderer.context.canvas.width,n=.5*renderer.context.canvas.height;return e.updateMatrixWorld(),o.setFromMatrixPosition(e.matrixWorld),o.project(t),o.x=o.x*i+i,o.y=-o.y*n+n,{x:o.x,y:o.y}}function toWorldPosition(e,t){var o=new THREE.Vector3;o.set(t.x,t.y,.5),o.unproject(camera);var i=o.sub(camera.position).normalize(),n=-(camera.position.z-50)/i.z;return camera.position.clone().add(i.multiplyScalar(n))}function onDocumentMouseDown(e){e.preventDefault(),raycaster.setFromCamera(mousePos,camera);var t=raycaster.intersectObjects(mapTiles);t.length>0&&(Player.targetPos.x=t[0].point.x,Player.targetPos.y=t[0].point.y)}function onRightClick(e){e.preventDefault(),raycaster.setFromCamera(mousePos,camera);var t=raycaster.intersectObjects(mapTiles);t.length>0&&(rightClick.x=t[0].point.x,rightClick.y=t[0].point.y),char.bulletFactory.create()}function init(){document.addEventListener("mousemove",handleMouseMove,!1),document.body.addEventListener("mousedown",function(e){0===e.button?(Player.isLeftClick=!0,onDocumentMouseDown(e)):2===e.button&&(Player.isRightClick=!0,onRightClick(e))},!1),document.body.addEventListener("mouseup",function(e){0===e.button?Player.isLeftClick=!1:2===e.button&&(Player.isRightClick=!1)},!1),document.addEventListener("contextmenu",function(e){return e.preventDefault()}),createScene(),createLights(),createBoardGame(),createCharacter(),enemiesCollision=new CollisionEngine,console.log(char.body.head.object),enemiesSpawn(),char.body.head.move(),char.body.rightArm.move(),char.body.leftArm.move(),char.body.rightLeg.move(),char.body.leftLeg.move(),blobl.animation(),bigBlobl.animation(),shootingBlobl.animation(),loop()}var deltaTime,mvtTime=0,newTime=Date.now(),oldTime=Date.now(),score=0;function loop(){deltaTime=newTime-oldTime,oldTime=newTime,newTime=Date.now(),mvtTime+=deltaTime,animateCharacter(char.body),blobl.move(),bigBlobl.move(),shootingBlobl.move(),enemiesCollision.testCollision(),char.bulletFactory.update(),renderer.render(scene,camera),requestAnimationFrame(loop)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var AnimationSystem=function e(){_classCallCheck(this,e),this.currentAnimation=null},Animation=function e(){_classCallCheck(this,e),this.enterAction=null,this.mainAction=null,this.exitAction=null},_createClass=function(){function e(e,t){for(var o=0;o<t.length;o++){var i=t[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,o,i){return o&&e(t.prototype,o),i&&e(t,i),t}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var Bullet=function(){function e(t,o,i,n){_classCallCheck(this,e),this.geom=new THREE.BoxGeometry(t,o,i,1,1,1),this.mat=new THREE.MeshPhongMaterial({color:n,flatShading:!0}),this.mesh=new THREE.Mesh(this.geom,this.mat),this.mvt={x:0,z:0}}return _createClass(e,[{key:"update",value:function(){this.mesh.position.x+=5*this.mvt.x,this.mesh.position.y+=5*this.mvt.y}}]),e}(),BulletFactory=function(){function e(){_classCallCheck(this,e),this.bullets=[]}return _createClass(e,[{key:"create",value:function(){var e=new Bullet(2,2,2,16777215);e.mesh.position.z=12,e.mesh.position.x=char.mesh.position.x,e.mesh.position.y=char.mesh.position.y;var t=rightClick.x-e.mesh.position.x,o=rightClick.y-e.mesh.position.y,i=Math.atan2(o,t);e.mvt.x=Math.cos(i),e.mvt.y=Math.sin(i),scene.add(e.mesh),Game.collidableMesh.push(e),this.bullets.push(e)}},{key:"update",value:function(){for(var e=0;e<this.bullets.length;e++)this.bullets[e].update()}}]),e}();_createClass=function(){function e(e,t){for(var o=0;o<t.length;o++){var i=t[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,o,i){return o&&e(t.prototype,o),i&&e(t,i),t}}();function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var char,CharColors={mainColor:664644,outlinerColor:14222184},speedRot=.03,Bodypart=function e(t,o,i,n,a){_classCallCheck(this,e),this.object=new THREE.Object3D,this.geom=new THREE.BoxGeometry(t,i,o,1,1,1),this.mat=new THREE.MeshPhongMaterial({color:n,flatShading:!0}),this.mesh=new THREE.Mesh(this.geom,this.mat),this.mesh.receiveShadow=!0,this.mesh.castShadow=!0,this.outlinerMat=new THREE.MeshBasicMaterial({color:CharColors.outlinerColor,side:THREE.BackSide}),this.outliner=new THREE.Mesh(this.geom,this.outlinerMat),this.outliner.scale.multiplyScalar(1.1),this.object.add(this.mesh),this.object.add(this.outliner),this.name=a},Leg=function(e){function t(e,o,i,n,a){_classCallCheck(this,t);var s=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,o,i,n,a));return s.mesh.geometry.translate(0,0,-1),s.mesh.position.z=-2,s.outliner.position.z=2.7,s.mesh.position.x="leftLeg"==s.name?-.9:.9,s.outliner.position.set(s.mesh.position.x,s.mesh.position.y,s.mesh.position.z),s.object.rotation.x="leftLeg"==s.name?-.8:.8,"leftLeg"==s.name?s.tween=TweenMax.to(s.object.rotation,.5,{x:.8,ease:Power0.easeInOut,repeat:-1,yoyo:!0}):s.tween=TweenMax.to(s.object.rotation,.5,{x:-.8,ease:Power0.easeInOut,repeat:-1,yoyo:!0}),s}return _inherits(t,Bodypart),_createClass(t,[{key:"move",value:function(){this.tween}}]),t}(),Arm=function(e){function t(e,o,i,n,a){_classCallCheck(this,t);var s=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,o,i,n,a));return s.mesh.geometry.translate(0,0,-1.2),s.mesh.position.z=.6,s.mesh.position.x="leftArm"==s.name?-2.4:2.4,s.outliner.position.set(s.mesh.position.x,s.mesh.position.y,s.mesh.position.z),s.object.rotation.x="rightArm"==s.name?-1:1,"rightArm"==s.name?s.tween=TweenMax.to(s.object.rotation,.5,{x:1,ease:Power0.easeInOut,repeat:-1,yoyo:!0}):s.tween=TweenMax.to(s.object.rotation,.5,{x:-1,ease:Power0.easeInOut,repeat:-1,yoyo:!0}),s}return _inherits(t,Bodypart),_createClass(t,[{key:"move",value:function(){this.tween}}]),t}(),Head=function(e){function t(e,o,i,n,a){_classCallCheck(this,t);var s=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,o,i,n,a));return s.mesh.position.z=4,s.outliner.position.set(s.mesh.position.x,s.mesh.position.y,s.mesh.position.z),s.rightEye=new Bodypart(.8,.8,.8,16777215,"rightEye"),s.rightEye.mesh.position.x+=1,s.rightEye.mesh.position.y-=2.3,s.rightEye.mesh.position.z+=.8,s.mesh.add(s.rightEye.mesh),s.leftEye=new Bodypart(.8,.8,.8,268435455,"leftEye"),s.leftEye.mesh.position.x+=-1,s.leftEye.mesh.position.y-=2.3,s.leftEye.mesh.position.z+=.8,s.mesh.add(s.leftEye.mesh),s.mvt="up",s.headMvt=.025,s}return _inherits(t,Bodypart),_createClass(t,[{key:"move",value:function(){TweenMax.to(this.outliner.position,.25,{z:4.5,repeat:-1,yoyo:!0}),TweenMax.to(this.mesh.position,.25,{z:4.5,repeat:-1,yoyo:!0})}}]),t}(),Body=function(e){function t(e,o,i,n,a){_classCallCheck(this,t);var s=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,o,i,n,a));return s.mvt=!1,s.movable=[],s.object.rotation.set(-Math.PI/2,0,0),s.head=new Head(4.8,4.8,4.8,CharColors.mainColor,"head"),s.object.add(s.head.mesh),s.object.add(s.head.outliner),s.leftLeg=new Leg(1.6,1,1.8,CharColors.mainColor,"leftLeg"),s.rightLeg=new Leg(1.6,1,1.8,CharColors.mainColor,"rightLeg"),s.object.add(s.leftLeg.object),s.object.add(s.rightLeg.object),s.movable.push(s.leftLeg,s.rightLeg),s.leftArm=new Arm(.8,2.4,1,CharColors.mainColor,"leftArm"),s.rightArm=new Arm(.8,2.4,1,CharColors.mainColor,"rightArm"),s.object.add(s.leftArm.object),s.object.add(s.rightArm.object),s.movable.push(s.leftArm,s.rightArm),s}return _inherits(t,Bodypart),_createClass(t,[{key:"update",value:function(){}},{key:"move",value:function(){for(var e=0;e<this.movable.length;e++);}}]),t}(),Char=function(){function e(t){_classCallCheck(this,e),this.mesh=new THREE.Object3D,this.mesh.name="character",this.name=t,this.state="still",this.mvt="false",this.body=new Body(4,4,2.8,CharColors.mainColor),this.mesh.add(this.body.object),this.bulletFactory=new BulletFactory}return _createClass(e,[{key:"move",value:function(){if(this.body.move(),Player.isLeftClick||this.body.mvt){var e=Player.targetPos.x-this.mesh.position.x,t=Player.targetPos.y-this.mesh.position.y,o=Math.atan2(t,e),i=Math.cos(o),n=Math.sin(o);this.mesh.position.x+=.9*i,this.mesh.position.y+=.9*n,Math.ceil(Player.targetPos.x/10)==Math.ceil(this.mesh.position.x/10)&&Math.ceil(Player.targetPos.y/10)==Math.ceil(this.mesh.position.y/10)?this.body.mvt=!1:this.body.mvt=!0}var a=new THREE.Vector3(mouseProjectPos.x,mouseProjectPos.y,12);this.mesh.up=new THREE.Vector3(0,0,1),this.mesh.lookAt(a)}}]),e}();function createCharacter(){(char=new Char).body.mesh.geometry.center(),char.mesh.position.z=11,char.mesh.position.x-=20,char.mesh.scale.set(1.5,1.5,1.5),scene.add(char.mesh)}function animateCharacter(e){char.move()}_createClass=function(){function e(e,t){for(var o=0;o<t.length;o++){var i=t[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,o,i){return o&&e(t.prototype,o),i&&e(t,i),t}}();function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var blobl,bigBlobl,shootingBlobl,Enemy=function(){function e(t,o,i,n,a){_classCallCheck(this,e),this.geom=new THREE.BoxGeometry(t,o,i,1,1,1),this.mat=new THREE.MeshPhongMaterial({color:n,flatShading:!0}),this.texture=(new THREE.TextureLoader).load("./src/img/crate.jpg"),this.material=new THREE.MeshBasicMaterial({map:this.texture}),this.mesh=new THREE.Mesh(this.geom,this.mat),this.mesh.castShadow=!0,this.name=a,this.collison=!1,this.objectInCollision=null,this.mvt=!0}return _createClass(e,[{key:"update",value:function(){this.collision&&this.hitAction(this.objectInColllision),this.mvt&&this.move()}},{key:"animation",value:function(){console.log("yeah")}},{key:"move",value:function(e,t){}},{key:"hitAction",value:function(e){this.mvt=!1}}]),e}(),SimpleEnemy=function(e){function t(e,o,i,n,a){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,o,i,n,a))}return _inherits(t,Enemy),_createClass(t,[{key:"animation",value:function(){TweenMax.to(this.mesh.position,.4,{z:16,ease:Power2.easeOut,repeat:-1,yoyo:!0}),TweenMax.to(this.mesh.scale,.4,{z:2.1,y:1.9,x:1.9,ease:Power2.easeOut,repeat:-1,yoyo:!0}),TweenMax.fromTo(this.mesh.rotation,.4,{x:.1,ease:Power2.easeOut,repeat:-1,yoyo:!0},{x:-.1,ease:Power2.easeOut,repeat:-1,yoyo:!0})}}]),t}(),BigEnemy=function(e){function t(e,o,i,n,a){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,o,i,n,a))}return _inherits(t,Enemy),_createClass(t,[{key:"animation",value:function(){TweenMax.to(this.mesh.position,.6,{z:22,ease:Power3.easeOut,repeat:-1,yoyo:!0}),TweenMax.fromTo(this.mesh.scale,.6,{z:1.6,y:2.1,x:2.1,ease:Power2.easeOut,repeat:-1,yoyo:!0},{z:2.1,y:1.9,x:1.9,ease:Power2.easeOut,repeat:-1,yoyo:!0})}}]),t}(),ShootingEnemy=function(e){function t(e,o,i,n,a){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,o,i,n,a))}return _inherits(t,Enemy),_createClass(t,[{key:"animation",value:function(){TweenMax.to(this.mesh.position,.5,{z:22,ease:Power3.easeOut,repeat:-1,yoyo:!0}),TweenMax.from(this.mesh.scale,.5,{z:1,y:2.2,x:2.2,ease:Power2.easeOut,repeat:-1,yoyo:!0}),TweenMax.to(this.mesh.rotation,.5,{x:.1,ease:Power2.easeOut,repeat:-1,yoyo:!0})}}]),t}();function removeSelf(){console.log("remove")}function enemiesSpawn(){(blobl=new SimpleEnemy(4,4,4,10076749,"blobl")).mesh.position.x+=20,blobl.mesh.position.z+=10,blobl.mesh.scale.set(2,2,2),console.log(blobl.mesh),scene.add(blobl.mesh),Game.enemies.push(blobl),enemiesCollision.addBody(blobl),(bigBlobl=new BigEnemy(8,8,8,10076749,"bigBlobl")).mesh.position.x+=45,bigBlobl.mesh.position.z+=16,bigBlobl.mesh.scale.set(2,2,2),scene.add(bigBlobl.mesh),(shootingBlobl=new ShootingEnemy(4,4,10,10076749,"shootingBlobl")).mesh.position.z+=16,shootingBlobl.mesh.scale.set(2,2,2),scene.add(shootingBlobl.mesh)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var board,drillingMachine,BoardGame=function e(){_classCallCheck(this,e),this.mesh=new THREE.Object3D,this.tileSize=12,this.size=32;for(var t=new THREE.BoxBufferGeometry(this.tileSize,this.tileSize,this.tileSize),o=0;o<32;o++){o<16?1:1;for(var i=0;i<32;i++){i<16?1:1;for(var n=0;n<1;n++){var a=new THREE.Mesh(t,new THREE.MeshPhongMaterial({color:6250335,flatShading:!0}));a.position.x=o*(1.05*this.tileSize),a.position.y=i*(1.05*this.tileSize),a.position.z=-n*(1.05*this.tileSize),a.castShadow=!0,a.receiveShadow=!0,this.mesh.add(a),mapTiles.push(a)}}}},mapTiles=[];function createBoardGame(){(board=new BoardGame(Colors.blue)).mesh.translateX(1.05*board.tileSize*-16),board.mesh.translateY(1.05*board.tileSize*-16),board.mesh.matrixAutoUpdate=!1,board.mesh.updateMatrix(),scene.add(board.mesh)}var DrillingMachine=function e(){_classCallCheck(this,e),this.geom=new THREE.BoxGeometry(24,24,24,1,1,1),this.mesh=new THREE.Mesh(this.geom,new THREE.MeshBasicMaterial({color:1581167,side:THREE.BackSide}))};function createDrilling(){(drillingMachine=new DrillingMachine).mesh.position.z+=50,scene.add(drillingMachine.mesh)}_createClass=function(){function e(e,t){for(var o=0;o<t.length;o++){var i=t[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,o,i){return o&&e(t.prototype,o),i&&e(t,i),t}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var CollisionEngine=function(){function e(){_classCallCheck(this,e),this.bodies=[]}return _createClass(e,[{key:"testCollision",value:function(){for(var e=0;e<this.bodies.length;e++)for(var t=this.bodies[e],o=(new THREE.Box3).setFromObject(t.mesh),i=0;i<Game.collidableMesh.length;i++){var n=Game.collidableMesh[i],a=(new THREE.Box3).setFromObject(n.mesh);o.intersectsBox(a)&&(this.bodies[e].collision=!0,this.bodies[e].objectInCollision=Game.collidableMesh[i])}}},{key:"addBody",value:function(e){this.bodies.push(e)}},{key:"removeBody",value:function(e){var t=this.bodies.indexOf(e);t>=0&&this.bodies.splice(t,1)}}]),e}();